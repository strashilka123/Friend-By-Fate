using UnityEngine;
using TMPro; // –î–ª—è —Ä–∞–±–æ—Ç—ã —Å —Ç–µ–∫—Å—Ç–æ–º TextMeshPro

public class PuzzleTile : MonoBehaviour
{
    // --- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤ –ò–Ω—Å–ø–µ–∫—Ç–æ—Ä–µ ---
    
    [Header("–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ü–ª–∏—Ç–∫–∏")]
    // –£–≥–æ–ª, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –ø–ª–∏—Ç–∫–∞ –¥–æ–ª–∂–Ω–∞ –ø–æ–≤–µ—Ä–Ω—É—Ç—å—Å—è –¥–ª—è –ø–æ–±–µ–¥—ã (0, 90, 180, 270)
    public float winRotationZ = 0f; 

    // –°–∫–æ—Ä–æ—Å—Ç—å –≤—Ä–∞—â–µ–Ω–∏—è (200 - —Ö–æ—Ä–æ—à–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –¥–ª—è –ø–ª–∞–≤–Ω–æ–≥–æ –ø–æ–≤–æ—Ä–æ—Ç–∞)
    public float rotationSpeed = 200f; 

    [Header("UI –ù–∞—Å—Ç—Ä–æ–π–∫–∞")]
    // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–æ–±–µ–¥–µ
    public TMP_Text winText;
    // –°—Å—ã–ª–∫–∞ –Ω–∞ —Ñ–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è –æ –ø–æ–±–µ–¥–µ (—á—Ç–æ–±—ã —É–ª—É—á—à–∏—Ç—å —á–∏—Ç–∞–µ–º–æ—Å—Ç—å)
    public GameObject winBackground; 
    
    // --- –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ ---
    
    // –§–ª–∞–≥, –∫–æ—Ç–æ—Ä—ã–π –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç, –≤—Ä–∞—â–∞–µ—Ç—Å—è –ª–∏ –ø–ª–∏—Ç–∫–∞ —Å–µ–π—á–∞—Å
    private bool isRotating = false;
    
    // –¶–µ–ª–µ–≤–æ–π —É–≥–æ–ª –≤—Ä–∞—â–µ–Ω–∏—è Z
    private float targetRotationZ; 

    // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑, –∫–æ–≥–¥–∞ —Å–∫—Ä–∏–ø—Ç –Ω–∞—á–∏–Ω–∞–µ—Ç —Ä–∞–±–æ—Ç—É
    void Start()
    {
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ü–µ–ª—å –≤—Ä–∞—â–µ–Ω–∏—è —Ä–∞–≤–Ω–æ–π —Ç–µ–∫—É—â–µ–º—É —É–≥–ª—É (0, 90, 180 –∏–ª–∏ 270)
        targetRotationZ = transform.localEulerAngles.z; 
    }

    // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –∫–∞–∂–¥—ã–π –∫–∞–¥—Ä
    void Update()
    {
        // –ï—Å–ª–∏ –ø–ª–∏—Ç–∫–∞ –≤—Ä–∞—â–∞–µ—Ç—Å—è, –ø–ª–∞–≤–Ω–æ –ø–æ–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –µ–µ –∫ —Ü–µ–ª–∏
        if (isRotating)
        {
            // –ü–ª–∞–≤–Ω–æ –¥–≤–∏–≥–∞–µ–º—Å—è –∫ —Ü–µ–ª–µ–≤–æ–º—É —É–≥–ª—É
            float newRotationZ = Mathf.MoveTowardsAngle(transform.localEulerAngles.z, targetRotationZ, rotationSpeed * Time.deltaTime);
            transform.localEulerAngles = new Vector3(0, 0, newRotationZ);

            // –ï—Å–ª–∏ –¥–æ—Å—Ç–∏–≥–ª–∏ —Ü–µ–ª–∏, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–±–µ–¥—É
            if (Mathf.Approximately(transform.localEulerAngles.z, targetRotationZ))
            {
                isRotating = false;
                CheckForWin();
            }
        }
    }

    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –º—ã—à–∏ –ø–æ –æ–±—ä–µ–∫—Ç—É (—Ç—Ä–µ–±—É–µ—Ç—Å—è Box Collider 2D!)
    void OnMouseDown()
    {
        // –ï—Å–ª–∏ –ø–ª–∏—Ç–∫–∞ —É–∂–µ –≤—Ä–∞—â–∞–µ—Ç—Å—è, –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫
        if (isRotating) return; 

        // –ó–∞–¥–∞–µ–º –Ω–æ–≤—ã–π —Ü–µ–ª–µ–≤–æ–π —É–≥–æ–ª (–ø–æ–≤–æ—Ä–æ—Ç –Ω–∞ 90 –≥—Ä–∞–¥—É—Å–æ–≤)
        targetRotationZ += 90f;
        
        // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —É–≥–æ–ª –æ—Å—Ç–∞–µ—Ç—Å—è –≤ –ø—Ä–µ–¥–µ–ª–∞—Ö 0-360
        if (targetRotationZ >= 360f)
        {
            targetRotationZ -= 360f;
        }

        isRotating = true; // –ù–∞—á–∏–Ω–∞–µ–º –≤—Ä–∞—â–µ–Ω–∏–µ
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞, —Å–æ–±—Ä–∞–Ω–∞ –ª–∏ –≤—Å—è –≥–æ–ª–æ–≤–æ–ª–æ–º–∫–∞
    void CheckForWin()
    {
        // 1. –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ —Ç–µ–∫—É—â–∞—è –ø–ª–∏—Ç–∫–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏
        bool isCorrect = Mathf.Approximately(targetRotationZ, winRotationZ);

        // 2. –ï—Å–ª–∏ –ø–ª–∏—Ç–∫–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ –ø–ª–∏—Ç–∫–∏
        if (isCorrect)
        {
            // –ù–∞—Ö–æ–¥–∏–º –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã —Å–æ —Å–∫—Ä–∏–ø—Ç–æ–º PuzzleTile –Ω–∞ —Å—Ü–µ–Ω–µ
            PuzzleTile[] allTiles = FindObjectsOfType<PuzzleTile>();
            int correctTilesCount = 0;

            foreach (PuzzleTile tile in allTiles)
            {
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –ª–∏ –ö–ê–ñ–î–ê–Ø –ø–ª–∏—Ç–∫–∞ –≤ —Å–≤–æ–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ–ª–æ–∂–µ–Ω–∏–∏
                if (Mathf.Approximately(tile.targetRotationZ, tile.winRotationZ))
                {
                    correctTilesCount++;
                }
            }

            // –ï—Å–ª–∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —Å–æ–±—Ä–∞–Ω–Ω—ã—Ö –ø–ª–∏—Ç–æ–∫ —Ä–∞–≤–Ω–æ –æ–±—â–µ–º—É –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –ø–ª–∏—Ç–æ–∫ (4)
            if (correctTilesCount == allTiles.Length)
            {
                // –ü–û–ë–ï–î–ê! –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç –∏ —Ñ–æ–Ω
                Debug.Log("üéâ –°–ø–∞—Å–∏–±–æ! –í—ã –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–ª–∏ –ø–æ—Ä–≤–∞–Ω–Ω—É—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—é!");

                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
                if (winText != null) 
                {
                    winText.gameObject.SetActive(true);
                }
                
                // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º —Ñ–æ–Ω–æ–≤–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                if (winBackground != null) 
                {
                    winBackground.SetActive(true);
                }
            }
        }
    }
}